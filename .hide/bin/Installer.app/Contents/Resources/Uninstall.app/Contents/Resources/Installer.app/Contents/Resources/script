#!/bin/bash
osascript -e 'quit app "System Preferences"'
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
if [ $# -eq 0 ]; then
  screen=Aerial
else 
  screen=$1
fi
saver='.saver'
adaptive_wait () {
TIMEOUT=25
  until [ -d ~/Library/Screen\ Savers/$screen$saver ] || [ -d /Library/Screen\ Savers/$screen$saver ] || [ $TIMEOUT -eq 0 ] ; do
    if ! ((TIMEOUT % 5)); then
    osascript -e 'display notification "To allow for Decision/User Credentials" with title "Application Waiting"'
    fi
    sleep 1
    TIMEOUT=$[$TIMEOUT-1]
  done
}
shrink="$DIR/../../.."

echo $shrink
$shrink/.hide/app/uninstall/./2_unstage_launch_agent.sh
rm $shrink/.hide/app/install/.timestamp.txt 
$shrink/.hide/app/install/./1_check_resource.sh $screen$saver
adaptive_wait
osascript -e 'quit app "System Preferences"'
$shrink/.hide/app/install/./notify_and_defaults/2_local_install_workaround.sh $screen".saver"
$shrink/.hide/app/install/./launch_agent/3_install_launch_agent.sh dyna
rm -rf $shrink/.hide/bin/$screen".saver"
mv $shrink/.hide/bin/Uninstall.app  $shrink
mv $shrink/Installer.app      ../../../.hide/bin
